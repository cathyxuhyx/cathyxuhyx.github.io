var markers,markers_ba,markers_lu,markers_fq,realmarkers,realmarkers_lu,realmarkers_ba,realmarkers_fq,nhood,cbd,ut,newtmp,nhood_bound,tmp,hotlines,trends,routes,map=L.map("map",{center:[30.266926,-97.750519],zoom:13}),Stamen_TonerLite=L.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",minZoom:0,maxZoom:20,ext:"png"}).addTo(map),dataset="https://raw.githubusercontent.com/cathyxuhyx/MUSA801-Web-App/master/data/js_test1.csv",bldgarea="https://raw.githubusercontent.com/cathyxuhyx/MUSA801-Web-App/master/data/BA.csv",freq="https://raw.githubusercontent.com/cathyxuhyx/MUSA801-Web-App/master/data/FQ.csv",landuse="https://raw.githubusercontent.com/cathyxuhyx/MUSA801-Web-App/master/data/LU.csv",cbd_data="https://raw.githubusercontent.com/cathyxuhyx/MUSA801-Web-App/master/data/cbd.geojson",ut_data="https://raw.githubusercontent.com/cathyxuhyx/MUSA801-Web-App/master/data/ut.geojson",nhood_data="https://raw.githubusercontent.com/cathyxuhyx/MUSA801-Web-App/master/data/nhood.geojson",hotline_data="https://raw.githubusercontent.com/cathyxuhyx/MUSA801-Web-App/master/data/hotlines.geojson",hotline_trend_data="https://raw.githubusercontent.com/cathyxuhyx/MUSA801-Web-App/master/data/route_js.json",routes_data="https://raw.githubusercontent.com/cathyxuhyx/MUSA801-Web-App/master/data/routes.geojson",austin=[],ba=[],fq=[],lu=[];color_ridership=chroma.scale("YlGnBu").colors(6);var t,newRoute,newRoute_b,route_layer,myStyle=function(e){var a,o,r,t,i;return e.length>37?(a=Number(e[e.length-1]).toFixed(2),o=Number(e[39]).toFixed(3),r=Number(e[33]).toFixed(3),t=Number(e[31]).toFixed(3),a<125?{color:color_ridership[1],opacity:.6,weight:5,fillColor:color_ridership[1],radius:3,stop_id:e[2],mean_on:a,residential:o,commercial:r,building_area:t}:a>=125&&a<250?{color:color_ridership[2],opacity:.6,weight:5,fillColor:color_ridership[2],radius:3,stop_id:e[2],mean_on:a,residential:o,commercial:r,building_area:t}:a>=250&&a<300?{color:color_ridership[3],opacity:.6,weight:5,fillColor:color_ridership[3],radius:3,stop_id:e[2],mean_on:a,residential:o,commercial:r,building_area:t}:a>=300&&a<400?{color:color_ridership[4],opacity:.6,weight:5,fillColor:color_ridership[4],radius:3,stop_id:e[2],mean_on:a,residential:o,commercial:r,building_area:t}:a>=400?{color:color_ridership[5],opacity:.6,weight:5,fillColor:color_ridership[5],radius:3,stop_id:e[2],mean_on:a,residential:o,commercial:r,building_area:t}:{color:"transparent",opacity:0,weight:5,fillColor:"transparent",radius:3,stop_id:e[2],mean_on:a,residential:o,commercial:r,building_area:t}):(i=Number(e[36]).toFixed(3),o=Number(e[6]).toFixed(3),r=Number(e[5]).toFixed(3),t=Number(e[3]).toFixed(3),a=Number(e[34]).toFixed(3),i<-33?{color:color_ridership[1],opacity:.6,weight:5,fillColor:color_ridership[1],radius:3,stop_id:e[2],mean_on:a,change:i,residential:o,commercial:r,building_area:t}:i>=-33&&i<4&&0!=i?{color:color_ridership[2],opacity:.6,weight:5,fillColor:color_ridership[2],radius:3,stop_id:e[2],mean_on:a,change:i,residential:o,commercial:r,building_area:t}:i>=4&&i<42?{color:color_ridership[3],opacity:.6,weight:5,fillColor:color_ridership[3],radius:3,mean_on:a,change:i,residential:o,commercial:r,building_area:t}:i>=42&&i<80?{color:color_ridership[4],opacity:.6,weight:5,fillColor:color_ridership[4],radius:3,stop_id:e[2],mean_on:a,change:i,residential:o,commercial:r,building_area:t}:i>=80?{color:color_ridership[5],opacity:.6,weight:5,fillColor:color_ridership[5],radius:3,stop_id:e[2],mean_on:a,change:i,residential:o,commercial:r,building_area:t}:0==i?{color:"#dadada",opacity:.3,weight:5,fillColor:"#dadada",radius:2,stop_id:e[2],mean_on:a,change:i,residential:o,commercial:r,building_area:t}:{color:"transparent",opacity:0,weight:5,fillColor:"transparent",radius:3,stop_id:e[2],mean_on:a,change:i,residential:o,commercial:r,building_area:t})},makeMarkers=function(e){return addmarker=_.map(_.rest(e),function(e){if(lat=Number(e[1]),lng=Number(e[0]),!isNaN(lat)&&!isNaN(lng))return L.circleMarker([lat,lng],myStyle(e))}),addmarker},plotMarkers=function(e){_.each(e,function(e){if(void 0!==e)return e.addTo(map)})},removeMarkers=function(e){_.each(e,function(e){if(void 0!==e)return map.removeLayer(e)})},showResults=function(){$("#intro").hide(),$("#stops").show()},closeResults=function(){$("#intro").show(),$("#stops").hide(),map.setView([30.266926,-97.750519],13)},clearScenarios=function(){document.getElementById("glance").checked=!1,myScenarioValue=undefined,removeMarkers(realmarkers_ba),removeMarkers(realmarkers_fq),removeMarkers(realmarkers_lu),plotMarkers(realmarkers),zoomin(realmarkers),scenariosList[0].selectize.clearOptions(),$(".sce-legend").hide(),$(".legend").show(),map.setView([30.266926,-97.750519],13)},eachFeatureFunction=function(e){void 0!==e&&e.on("click",function(e){t=e.target.options.mean_on,$("#stop-name").text(e.target.options.stop_id),$("#stop-boarding").text(parseFloat(e.target.options.mean_on).toFixed(2)),$("#stop-commercial").text(parseFloat(100*e.target.options.commercial).toFixed(2)),$("#stop-residential").text(parseFloat(100*e.target.options.residential).toFixed(2)),$("#stop-building").text(parseFloat(e.target.options.building_area).toFixed(2)),$("#delta").hide(),showResults(),void 0!==newtmp&&map.removeLayer(newtmp),tmp=e.target,(newtmp=L.circleMarker(tmp._latlng,{radius:12,color:"red"})).addTo(map),map.fitBounds([[tmp._latlng.lat-.003,tmp._latlng.lng-.003],[tmp._latlng.lat+.003,tmp._latlng.lng+.003]])})},eachFeatureFunction_sce=function(e){void 0!==e&&e.on("click",function(e){$("#stop-name").text(e.target.options.stop_id),$("#stop-boarding").text(parseFloat(e.target.options.mean_on).toFixed(2)),$("#stop-commercial").text(parseFloat(100*e.target.options.commercial).toFixed(2)),$("#stop-residential").text(parseFloat(100*e.target.options.residential).toFixed(2)),$("#stop-building").text(parseFloat(e.target.options.building_area).toFixed(2)),$("#change").text(parseFloat(e.target.options.change).toFixed(2)),$("#delta").show(),showResults(),void 0!==newtmp&&map.removeLayer(newtmp),tmp=e.target,(newtmp=L.circleMarker(tmp._latlng,{radius:12,color:"red"})).addTo(map),map.fitBounds([[tmp._latlng.lat-.003,tmp._latlng.lng-.003],[tmp._latlng.lat+.003,tmp._latlng.lng+.003]])})},zoomin=function(e){_.each(e,function(e){eachFeatureFunction(e)}),$("#return").click(function(){closeResults(),map.removeLayer(newtmp)})},zoomin_sce=function(e){_.each(e,function(e){eachFeatureFunction_sce(e)}),$("#return").click(function(){closeResults(),map.removeLayer(newtmp)})},hoverRoute=function(e){e.on("click",function(e){void 0!==newRoute&&(map.removeLayer(newRoute),map.removeLayer(newRoute_b)),route_layer=e.target,newRoute=L.geoJSON(route_layer.feature.geometry,{color:"#fff6cf",weight:9}),newRoute_b=L.geoJSON(route_layer.feature.geometry,{color:"#FDCE07",weight:12}),map.addLayer(newRoute_b),map.addLayer(newRoute);var a=turf.bbox(route_layer.feature.geometry);map.fitBounds([[a[1],a[0]-.1],[a[3],a[2]]]);var o=route_layer.feature.properties.ROUTE_ID;$("#chart").show(),drawCharts(trends,o)})},drawCharts=function(e,a){title=`Route ${a} Daily Ridership Summary`;bb.generate({title:{text:title,padding:{bottom:30}},size:{height:200,width:300},data:{columns:[["mean passenger load"].concat(e[a].mean_load)],types:{"mean passenger load":"area-spline"},colors:{"mean passenger load":"#FDCE07"}},point:{show:!1},area:{linearGradient:!0},zoom:{enabled:!0},tooltip:{linked:!0},axis:{x:{tick:{outer:!1,show:!1,text:{show:!1}}},y:{tick:{outer:!1,show:!0,stepSize:5}}},line:{classes:["line-class-data1"]},grid:{x:{show:!1},y:{show:!1}},bindto:"#chart1"}),bb.generate({size:{height:200,width:300},data:{columns:[["mean boarding"].concat(e[a].mean_on),["mean alighting"].concat(e[a].mean_off)],types:{"mean boarding":"area","mean alighting":"area"},colors:{"mean boarding":"#2166ac","mean alighting":"#ef8a62"}},point:{show:!1},area:{linearGradient:!0},zoom:{enabled:!0},tooltip:{linked:!0},axis:{x:{label:{position:"outer-center",text:"Stop Sequence ID"},tick:{count:5,outer:!1,show:!0}},y:{tick:{outer:!1,show:!0,stepSize:3}}},line:{classes:["line-class-data1","line-class-data1"]},grid:{x:{show:!1},y:{show:!1}},bindto:"#chart2"})},drawCharts2=function(){bb.generate({title:{text:"Average Daily Boarding by Different Regions"},data:{columns:[["CBD",325],["UT Austin",373],["Rest of Austin",294]],type:"bar",colors:{CBD:color_ridership[3],"UT Austin":color_ridership[5],"Rest of Austin":color_ridership[2]},labels:{colors:"white",centered:!0}},bar:{padding:20,radius:{ratio:.3}},tooltip:{show:!1},axis:{x:{tick:{outer:!1,show:!1,text:{show:!1}}},y:{tick:{outer:!1}}},bindto:"#chart3"})};$(document).ready(function(){$.ajax(routes_data).done(function(e){routes=JSON.parse(e),routes=L.geoJSON(routes,{color:"#bfe4e6",weight:3,opacity:.5}),map.addLayer(routes)}),$.ajax(dataset).done(function(e){for(var a=e.split("\n"),o=0;o<a.length;o+=1)austin.push(a[o].split(","));markers=makeMarkers(austin),realmarkers=_.filter(markers,function(e){return void 0!==e})}),$(".legend").append(`<b>2019 Average Daily Boarding per Stop&nbsp</b>\n    <span class = "dot" style="background-color:${color_ridership[1]}"></span>\n    <a> < 125&nbsp</a>\n    <span class = "dot" style="background-color:${color_ridership[2]}"></span>\n    <a> 125-250&nbsp</a>\n    <span class = "dot" style="background-color:${color_ridership[3]}"></span>\n    <a> 250-300&nbsp</a>\n    <span class = "dot" style="background-color:${color_ridership[4]}"></span>\n    <a> 300-400&nbsp</a>\n    <span class = "dot" style="background-color:${color_ridership[5]}"></span>\n    <a> > 400</a>`),$(".sce-legend").append(`<b>Changes of Average Daily Boarding per Stop&nbsp</b>\n    <span class = "dot" style="background-color:#dadada"></span>\n    <a> = 0</a>\n    <span class = "dot" style="background-color:${color_ridership[1]}"></span>\n    <a> < -33&nbsp</a>\n    <span class = "dot" style="background-color:${color_ridership[2]}"></span>\n    <a> -33-4&nbsp</a>\n    <span class = "dot" style="background-color:${color_ridership[3]}"></span>\n    <a> 4-42&nbsp</a>\n    <span class = "dot" style="background-color:${color_ridership[4]}"></span>\n    <a> 42-80&nbsp</a>\n    <span class = "dot" style="background-color:${color_ridership[5]}"></span>\n    <a> > 80</a>`),$.ajax(nhood_data).done(function(e){var a=turf.lineToPolygon(JSON.parse(e));nhood_bound=turf.bbox(a),nhood=L.geoJSON(a,{color:color_ridership[2],fillcolor:color_ridership[2],weight:0,opacity:.5,fillOpacity:.5})}),$.ajax(cbd_data).done(function(e){var a=turf.lineToPolygon(JSON.parse(e));cbd=L.geoJSON(a,{color:color_ridership[3],fillcolor:color_ridership[3],weight:0,opacity:.5,fillOpacity:.7})}),$.ajax(ut_data).done(function(e){var a=turf.lineToPolygon(JSON.parse(e));ut=L.geoJSON(a,{color:color_ridership[5],fillcolor:color_ridership[5],weight:0,opacity:.5,fillOpacity:.7})}),$.ajax(hotline_data).done(function(e){var a=JSON.parse(e);hotlines=L.geoJSON(a,{color:"#FDCE07",weight:9}),_.each(hotlines._layers,function(e){hoverRoute(e)})}),$.ajax(hotline_trend_data).done(function(e){trends=JSON.parse(e)})}),document.getElementById("glance").onchange=function(){1==this.checked?($(".sce-legend").hide(),plotMarkers(realmarkers),zoomin(realmarkers),$(".legend").show(),map.setView([30.266926,-97.750519],13)):($(".legend").hide(),removeMarkers(realmarkers))},document.getElementById("dt").onchange=function(){1==this.checked?(map.addLayer(nhood),map.addLayer(cbd),map.addLayer(ut),map.setView([30.296926,-97.800519],12),$("#chart_ridership").show(),drawCharts2(),$(".legend").hide(),$(".sce-legend").hide()):(map.removeLayer(nhood),map.removeLayer(cbd),map.removeLayer(ut),$("#chart_ridership").hide())},document.getElementById("route").onchange=function(){1==this.checked?(map.addLayer(hotlines),$(".legend").hide(),$(".sce-legend").hide(),map.setView([30.286926,-97.750519],12)):(map.removeLayer(hotlines),$("#chart").hide(),void 0!==newRoute&&(map.removeLayer(newRoute),map.removeLayer(newRoute_b)))},document.getElementById("close").onclick=function(){$("#chart").hide(),map.removeLayer(newRoute),map.removeLayer(newRoute_b),map.setView([30.266926,-97.750519],12)},document.getElementById("chart_ridership").onclick=function(){$("#chart_ridership").hide(),map.setView([30.266926,-97.750519],12)};var scenarios=document.getElementById("select-scenario");scenarios.onchange=function(){"LU"===myScenarioValue?(console.log(event.target.value),removeMarkers(realmarkers),$.ajax(landuse).done(function(e){for(var a=e.split("\n"),o=0;o<a.length;o+=1)lu.push(a[o].split(","));markers_lu=makeMarkers(lu),realmarkers_lu=_.filter(markers_lu,function(e){return void 0!==e}),plotMarkers(realmarkers_lu),zoomin_sce(realmarkers_lu),$(".legend").hide(),$(".sce-legend").show(),map.setView([30.326926,-97.750519],11)})):"BA"==myScenarioValue?(removeMarkers(realmarkers),$.ajax(bldgarea).done(function(e){for(var a=e.split("\n"),o=0;o<a.length;o+=1)ba.push(a[o].split(","));markers_ba=makeMarkers(ba),realmarkers_ba=_.filter(markers_ba,function(e){return void 0!==e}),plotMarkers(realmarkers_ba),zoomin_sce(realmarkers_ba),$(".legend").hide(),$(".sce-legend").show(),map.setView([30.326926,-97.750519],11)})):"FQ"==myScenarioValue&&(removeMarkers(realmarkers),$.ajax(freq).done(function(e){for(var a=e.split("\n"),o=0;o<a.length;o+=1)fq.push(a[o].split(","));markers_fq=makeMarkers(fq),realmarkers_fq=_.filter(markers_fq,function(e){return void 0!==e}),plotMarkers(realmarkers_fq),zoomin_sce(realmarkers_fq),$(".legend").hide(),$(".sce-legend").show(),map.setView([30.326926,-97.750519],11)}))},$("#OG").click(function(){clearScenarios()});var myScenarioValue,myFieldValue,myList,scenariosList=$("#select-scenario").selectize({create:!0,sortField:{field:"text",direction:"asc"},dropdownParent:"body",onChange:function(e){myScenarioValue=e}}),features=$("#select-feature").selectize({create:!0,sortField:{field:"text",direction:"asc"},dropdownParent:"body",onChange:function(e){console.log(myList),scenariosList[0].selectize.removeOption(scenariosList[0].selectize.getValue()),myList="BA"==e?{disabled:!1,text:"Building areas Increase 400,000 sqft",value:"BA"}:"LU"==e?{disabled:!1,text:"Commercial and Residential exchange by 10%",value:"LU"}:"FQ"==e?{disabled:!1,text:"Feeder Routes to High Frequency",value:"FQ"}:{disabled:!1,text:"Select a scenario...",value:"0"},scenariosList[0].selectize.addOption(myList),console.log(scenariosList[0].selectize)}});