var map=L.map("map",{center:[35.584675,10.114703],zoom:2}),Stamen_TonerLite=L.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",minZoom:0,maxZoom:20,ext:"png"}).addTo(map),today=new Date;today.setDate(today.getDate()-1),console.log(today);var yesterday=("00"+(today.getMonth()+1)).slice(-2)+"-"+("00"+today.getDate()).slice(-2)+"-"+today.getFullYear();$("#date").text(yesterday);const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];var markers,notUS,US_marker,dataset="https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/"+yesterday+".csv",myStyle=function(e){if(confirmed=e[7],death=e[8],confirmed&&death){if(confirmed<100)return{color:"red",fillColor:"#f03",opacity:.1,radius:.5,Country:e[3],State:e[2],City:e[1],Confirmed:e[7],Death:e[8],Recovered:e[9],Active:e[10]};if(confirmed<500&&confirmed>=100)return{color:"red",fillColor:"#f03",opacity:.3,radius:1,Country:e[3],State:e[2],City:e[1],Confirmed:e[7],Death:e[8],Recovered:e[9],Active:e[10]};if(confirmed<1e3&&confirmed>=500)return{color:"red",fillColor:"#f03",opacity:.4,radius:4,Country:e[3],State:e[2],City:e[1],Confirmed:e[7],Death:e[8],Recovered:e[9],Active:e[10]};if(confirmed<5e3&&confirmed>=1e3)return{color:"red",fillColor:"#f03",fillOpacity:.5,radius:7,Country:e[3],State:e[2],City:e[1],Confirmed:e[7],Death:e[8],Recovered:e[9],Active:e[10]};if(confirmed<1e4&&confirmed>=5e3)return{color:"red",fillColor:"#f03",fillOpacity:.6,radius:10,Country:e[3],State:e[2],City:e[1],Confirmed:e[7],Death:e[8],Recovered:e[9],Active:e[10]};if(confirmed>=1e4)return{color:"red",fillColor:"#f03",fillOpacity:.7,radius:14,Country:e[3],State:e[2],City:e[1],Confirmed:e[7],Death:e[8],Recovered:e[9],Active:e[10]}}},makeMarkers=function(e){return addmarker=_.map(_.rest(e),function(e){if(lat=Number(e[5]),lng=Number(e[6]),!isNaN(lat)&&!isNaN(lng))return L.circleMarker([lat,lng],myStyle(e))}),addmarker},plotMarkers=function(e){_.each(e,function(e){if(void 0!==e)return e.addTo(map)})},removeMarkers=function(e){_.each(e,function(e){if(void 0!==e)return map.removeLayer(e)})},showResults=function(){$("#intro").hide(),$("#USonly").hide(),$("#results").show()},closeResults=function(){$("#intro").show(),$("#USonly").hide(),$("#results").hide(),map.setView([38.8,-97.6129],4)},eachFeatureFunction=function(e){void 0!==e&&e.on("click",function(e){$(".city").text(e.target.options.City),$(".state").text(e.target.options.State),$(".country").text(e.target.options.Country),$("#confirmed").text(e.target.options.Confirmed),$("#death").text(e.target.options.Death),$("#recovered").text(e.target.options.Recovered),$("#active").text(e.target.options.Active),$("#month").text(monthNames[today.getMonth()]),$("#day").text(today.getDate()),$("#year").text(today.getFullYear()),showResults();var t=e.target;map.fitBounds([[t._latlng.lat-.5,t._latlng.lng-.5],[t._latlng.lat+.5,t._latlng.lng+.5]])})};$(document).ready(function(){$.ajax(dataset).done(function(e){var t=e.split("\n");worlddata=[];for(var o=0;o<t.length;o+=1)worlddata.push(t[o].split(","));filtered_worlddata=_.filter(worlddata,function(e){return Number(e[7])>0}),markers=makeMarkers(filtered_worlddata);var r=_.filter(markers,function(e){return void 0!==e});notUS=_.filter(r,function(e){return"US"!=e.options.Country}),US_marker=_.filter(r,function(e){return"US"==e.options.Country}),plotMarkers(notUS),plotMarkers(US_marker),_.each(markers,function(e){eachFeatureFunction(e)}),filtered=_.filter(worlddata,function(e){return"US"==e[3]}),colCounts=_.sortBy(filtered,function(e){return Number(e[7])}).reverse(),$("#Top1").text(colCounts[0][1]+", "+colCounts[0][2]+", "+colCounts[0][7]),$("#Top2").text(colCounts[1][1]+", "+colCounts[1][2]+", "+colCounts[1][7]),$("#Top3").text(colCounts[2][1]+", "+colCounts[2][2]+", "+colCounts[2][7]),$("#Top4").text(colCounts[3][1]+", "+colCounts[3][2]+", "+colCounts[3][7]),$("#Top5").text(colCounts[4][1]+", "+colCounts[4][2]+", "+colCounts[4][7])})}),$("button").click(function(){closeResults()});var US_only=function(){$("#intro").hide(),$("#USonly").show(),$("#results").hide(),map.setView([38.8,-97.6129],4)};$("button#world").click(function(){$("#intro").show(),$("#USonly").hide(),$("#results").hide(),map.setView([35.584675,10.114703],2);var e=_.filter(markers,function(e){return void 0!==e});notUS=_.filter(e,function(e){return"US"!=e.options.Country}),plotMarkers(notUS),void 0!==cens_pop&&(map.removeLayer(cens_pop),$(".legend#pop").hide()),void 0!==elder_pop&&(map.removeLayer(elder_pop),$(".legend#elder").hide())});var cens_pop,elder_pop,censusstyle1=function(e){return e.properties.B00001_001E>5e5?{fillColor:"#0c2c84"}:e.properties.B00001_001E>24e3?{fillColor:"#225ea8"}:e.properties.B00001_001E>9e3?{fillColor:"#1d91c0"}:e.properties.B00001_001E>3800?{fillColor:"#41b6c4"}:e.properties.B00001_001E>2e3?{fillColor:"#7fcdbb"}:e.properties.B00001_001E>1200?{fillColor:"#c7e9b4"}:{fillColor:"#ffffcc"}},censusstyle=function(e){return e.properties.DP05_0024PE>45?{fillColor:"#BD0026"}:e.properties.DP05_0024PE>35?{fillColor:"#E31A1C"}:e.properties.DP05_0024PE>25?{fillColor:"#FC4E2A"}:e.properties.DP05_0024PE>15?{fillColor:"#FD8D3C"}:e.properties.DP05_0024PE>5?{fillColor:"#FEB24C"}:{fillColor:"#FFF"}};$("button#population").click(function(){$(".legend#pop").show(),census({vintage:"2018",geoHierarchy:{county:"*"},geoResolution:"20m",sourcePath:["acs","acs5"],values:["B00001_001E"]},function(e,t){(cens_pop=L.geoJson(t.features,{weight:.5,color:"white",fillOpacity:.4,style:censusstyle1})).addTo(map)}),US_only()}),$("button#elder").click(function(){$(".legend#elder").show(),US_only(),census({vintage:"2018",geoHierarchy:{county:"*"},geoResolution:"20m",sourcePath:["acs","acs5","profile"],values:["DP05_0024PE"]},function(e,t){(elder_pop=L.geoJson(t.features,{weight:.5,color:"white",fillOpacity:.4,style:censusstyle})).addTo(map)})}),$("button#clear").click(function(){US_only(),void 0!==cens_pop&&(map.removeLayer(cens_pop),$(".legend#pop").hide()),void 0!==elder_pop&&(map.removeLayer(elder_pop),$(".legend#elder").hide())}),$("button#USresult").click(function(){removeMarkers(notUS),US_only()});